#!/bin/bash

echo "ğŸ”’ Persetujuan Privasi SMTD Team"

while true; do
  read -p "Apakah Kamu Setuju Dengan Kebijakan Privasi Dari SMTD Team? [Y/n]: " jawab
  jawab_lower=$(echo "$jawab" | tr '[:upper:]' '[:lower:]')

  if [[ "$jawab_lower" == "y" || "$jawab_lower" == "yes" || "$jawab_lower" == "ya" ]]; then
    echo "âœ… Terima kasih! Lanjutkan proses..."
    break
  else
    echo "âŒ Jawaban Harus Y/Yes/Ya"
  fi
done

# Lanjutkan script kamu di bawah ini
echo "ğŸš€ Menjalankan bagian selanjutnya dari script..."

echo "ğŸš€ Mulai generate SSL via Let's Encrypt (Manual DNS)"

red='\033[0;31m'
reset='\033[0m'

printf "${red}"
cat <<'EOF'
   _____ __  __ _______ _____    _______                   
  / ____|  \/  |__   __|  __ \  |__   __|                  
 | (___ | \  / |  | |  | |  | |    | | ___  __ _ _ __ ___  
  \___ \| |\/| |  | |  | |  | |    | |/ _ \/ _` | '_ ` _ \ 
  ____) | |  | |  | |  | |__| |    | |  __/ (_| | | | | | |
 |_____/|_|  |_|  |_|  |_____/     |_|\___|\__,_|_| |_| |_|
EOF
printf "${reset}\n"

read -p "Masukkan domain aktif kamu (wajib pointing ke DNS publik): " domain

echo "ğŸ“¦ Install certbot..."
sudo apt update -y
sudo apt install certbot -y

echo "ğŸŒ Jalankan certbot manual DNS challenge..."
certbot certonly \
  --manual \
  --preferred-challenges dns \
  --register-unsafely-without-email \
  --agree-tos \
  -d "$domain"

# Cek apakah berhasil
LIVE_DIR="/etc/letsencrypt/live/$domain"
if [ ! -d "$LIVE_DIR" ]; then
  echo "âŒ Gagal ambil sertifikat dari Let's Encrypt!"
  exit 1
fi

echo "âœ… SSL berhasil dibuat!"

# Salin file ke direktori kerja
cp "$LIVE_DIR/fullchain.pem" "./cert.pem"
cp "$LIVE_DIR/privkey.pem" "./key.pem"

echo "ğŸ“ File berhasil disalin:"
echo " - cert.pem (sertifikat)"
echo " - key.pem (private key)"
